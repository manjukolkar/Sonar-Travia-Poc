<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI/CD POC - Code Quality Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš€ CI/CD POC Dashboard</h1>
            <p>Code Quality & Security Scanning</p>
        </header>

        <div class="status-section">
            <h2>Service Status</h2>
            <div class="status-grid">
                <div class="status-card" id="sonar-status">
                    <h3>SonarQube</h3>
                    <div class="status-indicator" id="sonar-indicator">Checking...</div>
                </div>
                <div class="status-card" id="trivy-status">
                    <h3>Trivy</h3>
                    <div class="status-indicator" id="trivy-indicator">Checking...</div>
                </div>
            </div>
        </div>

        <div class="actions-section">
            <h2>Code Quality Checks</h2>
            
            <div class="action-card">
                <h3>SonarQube Analysis</h3>
                <p>Run code quality analysis using SonarQube</p>
                <button onclick="runSonarScan()" class="btn btn-primary">Run SonarQube Scan</button>
                <div id="sonar-results" class="results"></div>
            </div>

            <div class="action-card">
                <h3>Trivy Security Scan</h3>
                <p>Scan for security vulnerabilities</p>
                <div class="form-group">
                    <label for="scan-type">Scan Type:</label>
                    <select id="scan-type">
                        <option value="image">Docker Image</option>
                        <option value="fs">File System</option>
                    </select>
                </div>
                <div class="form-group" id="image-input-group">
                    <label for="image-name">Image Name:</label>
                    <input type="text" id="image-name" placeholder="app:latest" value="app:latest">
                </div>
                <button onclick="runTrivyScan()" class="btn btn-secondary">Run Trivy Scan</button>
                <div id="trivy-results" class="results"></div>
            </div>
        </div>

        <div class="info-section">
            <h2>Project Information</h2>
            <div class="info-card">
                <p><strong>Repository:</strong> Git</p>
                <p><strong>CI/CD:</strong> Jenkins</p>
                <p><strong>Containerization:</strong> Docker</p>
                <p><strong>Code Quality:</strong> SonarQube</p>
                <p><strong>Security:</strong> Trivy</p>
                <p><strong>Cloud:</strong> AWS EC2</p>
            </div>
        </div>
    </div>

    <script>
        // Check service status on load
        window.addEventListener('load', function() {
            checkServiceStatus();
            setInterval(checkServiceStatus, 30000); // Check every 30 seconds
        });

        function checkServiceStatus() {
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    updateStatusIndicator('sonar-indicator', data.services.sonarqube);
                    updateStatusIndicator('trivy-indicator', data.services.trivy);
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
        }

        function updateStatusIndicator(elementId, isActive) {
            const indicator = document.getElementById(elementId);
            if (isActive) {
                indicator.textContent = 'âœ“ Online';
                indicator.className = 'status-indicator active';
            } else {
                indicator.textContent = 'âœ— Offline';
                indicator.className = 'status-indicator inactive';
            }
        }

        function runSonarScan() {
            const resultsDiv = document.getElementById('sonar-results');
            resultsDiv.innerHTML = '<p class="loading">Running SonarQube scan... This may take a few minutes.</p>';
            
            fetch('/api/sonar/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ“ Scan Completed Successfully</h4>
                            <pre>${data.output}</pre>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h4>âœ— Scan Failed</h4>
                            <pre>${data.error || data.output}</pre>
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>âœ— Error</h4>
                        <pre>${error.message}</pre>
                    </div>
                `;
            });
        }

        function runTrivyScan() {
            const resultsDiv = document.getElementById('trivy-results');
            const scanType = document.getElementById('scan-type').value;
            const imageName = document.getElementById('image-name').value;
            
            resultsDiv.innerHTML = '<p class="loading">Running Trivy scan... This may take a few minutes.</p>';
            
            const payload = {
                type: scanType,
                image: imageName
            };
            
            fetch('/api/trivy/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const vulnerabilities = data.results?.Results || [];
                    let vulnCount = 0;
                    vulnerabilities.forEach(result => {
                        vulnCount += (result.Vulnerabilities || []).length;
                    });
                    
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ“ Scan Completed</h4>
                            <p><strong>Vulnerabilities Found:</strong> ${vulnCount}</p>
                            <details>
                                <summary>View Full Results</summary>
                                <pre>${JSON.stringify(data.results, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h4>âœ— Scan Failed</h4>
                            <pre>${data.error || JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>âœ— Error</h4>
                        <pre>${error.message}</pre>
                    </div>
                `;
            });
        }

        // Show/hide image input based on scan type
        document.getElementById('scan-type').addEventListener('change', function() {
            const imageInputGroup = document.getElementById('image-input-group');
            if (this.value === 'image') {
                imageInputGroup.style.display = 'block';
            } else {
                imageInputGroup.style.display = 'none';
            }
        });
    </script>
</body>
</html>

